// https://github.com/zz85/timeliner
function e(e, t) { this.state = e.getJSONString(), this.description = t } function t(e, t) { this.dispatcher = e, this.MAX_ITEMS = t || 100, this.clear() } function n() { var e = {}; this.on = function (t, n) { t in e || (e[t] = []), e[t].push(n) }, this.fire = function (t) { var n = Array.prototype.slice.call(arguments); n.shift(); var i = e[t]; if (i) for (var o = 0; o < i.length; o++) { var a = i[o]; a.apply(a, n) } } } t.prototype.save = function (e, t) { var n = this.states, i = this.index + 1, o = n.length - i; n.splice(i, o, e), n.length > this.MAX_ITEMS && n.shift(), this.index = n.length - 1, t || this.dispatcher.fire("state:save", e.description) }, t.prototype.clear = function () { this.states = [], this.index = -1 }, t.prototype.canUndo = function () { return this.index > 0 }, t.prototype.canRedo = function () { return this.index < this.states.length - 1 }, t.prototype.undo = function () { return this.canUndo() ? (this.dispatcher.fire("status", "Undo: " + this.get().description), this.index--) : this.dispatcher.fire("status", "Nothing to undo"), this.get() }, t.prototype.redo = function () { return this.canRedo() ? (this.index++, this.dispatcher.fire("status", "Redo: " + this.get().description)) : this.dispatcher.fire("status", "Nothing to redo"), this.get() }, t.prototype.get = function () { return this.states[this.index] }; const i = "#343434", o = "#535353", a = "#b8b8b8", r = "#d6d6d6"; var s, l, d = { LINE_HEIGHT: 26, DIAMOND_SIZE: 10, MARKER_TRACK_HEIGHT: 60, width: 600, height: 200, TIMELINE_SCROLL_HEIGHT: 0, LEFT_PANE_WIDTH: 250, time_scale: 60, default_length: 20, DEFAULT_TIME_SCALE: 60 }, c = { none: function (e) { return 0 }, linear: function (e) { return e }, quadEaseIn: function (e) { return e * e }, quadEaseOut: function (e) { return -e * (e - 2) }, quadEaseInOut: function (e) { return (e *= 2) < 1 ? .5 * e * e : -.5 * (--e * (e - 2) - 1) } }; function u(e) { var t = e.target.files; console.log("handle file select", t.length); var n = t[0]; if (n) { console.log("match", n.type); var i = new FileReader; i.onload = function (e) { var t = e.target.result; l(t) }, i.readAsText(n), s.value = "" } } function h(e) { var t = document.createEvent("MouseEvents"); t.initMouseEvent("click", !0, !1, window, 0, 0, 0, 0, 0, !1, !1, !1, !1, 0, null), e.dispatchEvent(t) } var p = { STORAGE_PREFIX: "timeliner-", firstDefined: function () { for (var e = 0; e < arguments.length; e++)if (void 0 !== arguments[e]) return arguments[e] }, style: function (e, ...t) { for (var n = 0; n < t.length; ++n) { var i = t[n]; for (var o in i) e.style[o] = i[o] } }, saveToFile: function (e, t) { var n = document.createElement("a"); document.body.appendChild(n), n.style = "display: none"; var i = new Blob([e], { type: "octet/stream" }), o = window.URL.createObjectURL(i); n.href = o, n.download = t, h(n), setTimeout((function () { window.URL.revokeObjectURL(o), document.body.removeChild(n) }), 500) }, openAs: function (e, t) { console.log("openfile..."), l = e, s || ((s = document.createElement("input")).style.display = "none", s.type = "file", s.addEventListener("change", u), (t = t || document.body).appendChild(s)), h(s) }, format_friendly_seconds: function (e, t) { var n = 0 | e, i = n % 60, o = (n / 60 | 0) % 60 + ":" + (i / 100).toFixed(2).substring(2); return e % 1 > 0 && ("frames" === t ? o = i + "+" + (e % 1 * 60).toFixed(0) + "f" : o += (e % 1).toFixed(2).substring(1)), o }, findTimeinLayer: function (e, t) { var n, i, o = e.values; for (n = 0, i = o.length; n < i; n++) { var a = o[n]; if (a.time === t) return { index: n, object: a }; if (a.time > t) return n } return n }, timeAtLayer: function (e, t) { var n, i, o, a, r = e.values; if (0 !== (i = r.length) && !e._mute) { if (t < (o = r[0]).time) return { value: o.value, can_tween: !1, keyframe: !1 }; for (n = 0; n < i; n++) { if (a = o, t === (o = r[n]).time) return n === i - 1 ? { entry: a, tween: a.tween, can_tween: i > 1, value: o.value, keyframe: !0 } : { entry: o, tween: o.tween, can_tween: i > 1, value: o.value, keyframe: !0 }; if (t < o.time) { if (!a.tween) return { value: a.value, tween: !1, entry: a, can_tween: !0, keyframe: !1 }; var s = o.time - a.time, l = o.value - a.value, d = a.tween, u = (t - a.time) / s; return { entry: a, value: a.value + c[d](u) * l, tween: a.tween, can_tween: !0, keyframe: !1 } } } return { value: o.value, can_tween: !1, keyframe: !1 } } }, proxy_ctx: function (e) { var t = {}; function n(n) { return function () { return e[n].apply(e, arguments), t } } function i(n) { return function (i) { return e[n] = i, t } } for (var o in t.run = function (e) { return e(t), t }, e) { switch (typeof e[o]) { case "object": break; case "function": t[o] = n(o); break; default: t[o] = i(o) } } return t } }; class f { constructor() { this.listeners = new Set } do(e) { this.listeners.add(e) } undo(e) { this.listeners.delete(e) } fire(...e) { for (let t of this.listeners) t(...e) } } function C(e, t, n, i, o) { var a = null, r = e.getBoundingClientRect(); function s(e) { d(e), n(a) } function l(t) { r = e.getBoundingClientRect(); var n = t.clientX, i = t.clientY; a = { startx: n, starty: i, x: n, y: i, dx: 0, dy: 0, offsetx: n - r.left, offsety: i - r.top, moved: !1 } } function d(t) { r = e.getBoundingClientRect(); var n = t.clientX, i = t.clientY, o = n - r.left, s = i - r.top; a.x = n, a.y = i, a.dx = t.clientX - a.startx, a.dy = t.clientY - a.starty, a.offsetx = o, a.offsety = s, a.moved = a.moved || 0 !== a.dx || 0 !== a.dy } function c(e) { d(e), i(a), a = null, document.removeEventListener("mousemove", s), document.removeEventListener("mouseup", c) } function u(e) { s(e.touches[0]) } function h(t) { c(t), e.removeEventListener("touchmove", u), e.removeEventListener("touchend", h) } e.addEventListener("mousedown", (function (e) { if (l(e), o && !o(a)) return void (a = null); document.addEventListener("mousemove", s), document.addEventListener("mouseup", c), t(a), e.preventDefault() })), e.addEventListener("touchstart", (function (n) { if (1 == n.touches.length) { var i = n.touches[0]; if (o && !o(i)) return; n.preventDefault(), l(i), t(a) } e.addEventListener("touchmove", u), e.addEventListener("touchend", h) })) } const { firstDefined: v, style: m } = p; function L(e) { var t = void 0 === (e = e || {}).min ? -1 / 0 : e.min, n = v(e.xstep, e.step, .001), i = v(e.ystep, e.step, .1), o = v(e.wheelStep, i), r = v(e.wheelStepFine, n), s = e.precision || 3, l = document.createElement("input"); m(l, { textAlign: "center", fontSize: "10px", padding: "1px", cursor: "ns-resize", width: "40px", margin: 0, marginRight: "10px", appearance: "none", outline: "none", border: 0, background: "none", borderBottom: "1px dotted " + a, color: a }); var d, c = this, u = 0; function h(e) { return Math.max(t, e) } function p() { c.onChange.fire(u) } this.onChange = new f, l.addEventListener("change", (function (e) { console.log("input changed", l.value), u = parseFloat(l.value, 10), p() })), l.addEventListener("keydown", (function (e) { e.stopPropagation() })), l.addEventListener("focus", (function (e) { l.setSelectionRange(0, l.value.length) })), l.addEventListener("wheel", (function (e) { var t = e.deltaY > 0 ? 1 : -1; e.altKey ? t *= r : t *= o, u = h(u + t), p() })), C(l, (function (e) { d = u }), (function (e) { var t = e.dx, o = e.dy; u = h(u = d + t * n + o * -i), c.onChange.fire(u, !0) }), (function (e) { e.moved ? p() : l.focus() })), this.dom = l, this.setValue = function (e) { u = e, l.value = u.toFixed(s) }, this.paint = function () { u && document.activeElement !== l && (l.value = u.toFixed(s)) } } function g(e, t) { var n = document.createElement("div"), r = document.createElement("span"); r.style.cssText = "font-size: 12px; padding: 4px;", r.addEventListener("click", (function (e) { })), r.addEventListener("mouseover", (function (e) { })); var s, l = document.createElement("select"); for (var u in l.style.cssText = "font-size: 10px; width: 60px; margin: 0; float: right; text-align: right;", c) (s = document.createElement("option")).text = u, l.appendChild(s); l.addEventListener("change", (function (n) { t.fire("ease", e, l.value) })); var h = d.LINE_HEIGHT - 1, f = document.createElement("button"); function C(e) { var t = document.createElement("button"); t.textContent = e, p.style(t, { fontSize: "12px", padding: "1px", borderSize: "2px", outline: "none", background: i, color: a }), this.pressed = !1, t.onclick = () => { this.pressed = !this.pressed, p.style(t, { borderStyle: this.pressed ? "inset" : "outset" }), this.onClick && this.onClick() }, this.dom = t } f.innerHTML = "&#9672;", f.style.cssText = "background: none; font-size: 12px; padding: 0px; font-family: monospace; float: right; width: 20px; height: " + h + "px; border-style:none; outline: none;", f.addEventListener("click", (function (n) { console.log("clicked:keyframing...", g.get("_value").value), t.fire("keyframe", e, g.get("_value").value) })); var v = new C("S"); n.appendChild(v.dom), v.onClick = function () { t.fire("action:solo", e, v.pressed) }; var m = new C("M"); n.appendChild(m.dom), m.onClick = function () { t.fire("action:mute", e, m.pressed) }; var g, w = new L(e, t); function y(n) { l.style.opacity = 0, l.disabled = !0, f.style.color = o; var i = p.timeAtLayer(e, n); i && (i.can_tween && (l.style.opacity = 1, l.disabled = !1, l.value = i.tween ? i.tween : "none", "none" === l.value && (l.style.opacity = .5)), i.keyframe && (f.style.color = a), g.get("_value").value = i.value, w.setValue(i.value), w.paint(), t.fire("target.notify", e.name, i.value)) } w.onChange.do((function (n, i) { g.get("_value").value = n, t.fire("value.change", e, n, i) })), p.style(w.dom, { float: "right" }), n.appendChild(r), n.appendChild(f), n.appendChild(w.dom), n.appendChild(l), p.style(n, { textAlign: "left", margin: "0px 0px 0px 5px", borderBottom: "1px solid " + o, top: 0, left: 0, height: d.LINE_HEIGHT - 1 + "px", color: a }), this.dom = n, this.repaint = y, this.setState = function (t, n) { e = t; var i = (g = n).get("_value"); void 0 === i.value && (i.value = 0), w.setValue(i.value), r.textContent = g.get("name").value, y() } } const w = { unitsPerEm: 1792, ascender: 1536, descender: -256, fonts: { plus: { advanceWidth: 1408, commands: "M,1408,800 C,1408,853,1365,896,1312,896 L,896,896 L,896,1312 C,896,1365,853,1408,800,1408 L,608,1408 C,555,1408,512,1365,512,1312 L,512,896 L,96,896 C,43,896,0,853,0,800 L,0,608 C,0,555,43,512,96,512 L,512,512 L,512,96 C,512,43,555,0,608,0 L,800,0 C,853,0,896,43,896,96 L,896,512 L,1312,512 C,1365,512,1408,555,1408,608 Z" }, minus: { advanceWidth: 1408, commands: "M,1408,800 C,1408,853,1365,896,1312,896 L,96,896 C,43,896,0,853,0,800 L,0,608 C,0,555,43,512,96,512 L,1312,512 C,1365,512,1408,555,1408,608 Z" }, ok: { advanceWidth: 1792, commands: "M,1671,970 C,1671,995,1661,1020,1643,1038 L,1507,1174 C,1489,1192,1464,1202,1439,1202 C,1414,1202,1389,1192,1371,1174 L,715,517 L,421,812 C,403,830,378,840,353,840 C,328,840,303,830,285,812 L,149,676 C,131,658,121,633,121,608 C,121,583,131,558,149,540 L,511,178 L,647,42 C,665,24,690,14,715,14 C,740,14,765,24,783,42 L,919,178 L,1643,902 C,1661,920,1671,945,1671,970 Z" }, remove: { advanceWidth: 1408, commands: "M,1298,214 C,1298,239,1288,264,1270,282 L,976,576 L,1270,870 C,1288,888,1298,913,1298,938 C,1298,963,1288,988,1270,1006 L,1134,1142 C,1116,1160,1091,1170,1066,1170 C,1041,1170,1016,1160,998,1142 L,704,848 L,410,1142 C,392,1160,367,1170,342,1170 C,317,1170,292,1160,274,1142 L,138,1006 C,120,988,110,963,110,938 C,110,913,120,888,138,870 L,432,576 L,138,282 C,120,264,110,239,110,214 C,110,189,120,164,138,146 L,274,10 C,292,-8,317,-18,342,-18 C,367,-18,392,-8,410,10 L,704,304 L,998,10 C,1016,-8,1041,-18,1066,-18 C,1091,-18,1116,-8,1134,10 L,1270,146 C,1288,164,1298,189,1298,214 Z" }, zoom_in: { advanceWidth: 1664, commands: "M,1024,736 C,1024,753,1009,768,992,768 L,768,768 L,768,992 C,768,1009,753,1024,736,1024 L,672,1024 C,655,1024,640,1009,640,992 L,640,768 L,416,768 C,399,768,384,753,384,736 L,384,672 C,384,655,399,640,416,640 L,640,640 L,640,416 C,640,399,655,384,672,384 L,736,384 C,753,384,768,399,768,416 L,768,640 L,992,640 C,1009,640,1024,655,1024,672 M,1152,704 C,1152,457,951,256,704,256 C,457,256,256,457,256,704 C,256,951,457,1152,704,1152 C,951,1152,1152,951,1152,704 M,1664,-128 C,1664,-94,1650,-61,1627,-38 L,1284,305 C,1365,422,1408,562,1408,704 C,1408,1093,1093,1408,704,1408 C,315,1408,0,1093,0,704 C,0,315,315,0,704,0 C,846,0,986,43,1103,124 L,1446,-218 C,1469,-242,1502,-256,1536,-256 C,1607,-256,1664,-199,1664,-128 Z" }, zoom_out: { advanceWidth: 1664, commands: "M,1024,736 C,1024,753,1009,768,992,768 L,416,768 C,399,768,384,753,384,736 L,384,672 C,384,655,399,640,416,640 L,992,640 C,1009,640,1024,655,1024,672 M,1152,704 C,1152,457,951,256,704,256 C,457,256,256,457,256,704 C,256,951,457,1152,704,1152 C,951,1152,1152,951,1152,704 M,1664,-128 C,1664,-94,1650,-61,1627,-38 L,1284,305 C,1365,422,1408,562,1408,704 C,1408,1093,1093,1408,704,1408 C,315,1408,0,1093,0,704 C,0,315,315,0,704,0 C,846,0,986,43,1103,124 L,1446,-218 C,1469,-242,1502,-256,1536,-256 C,1607,-256,1664,-199,1664,-128 Z" }, cog: { advanceWidth: 1536, commands: "M,1024,640 C,1024,499,909,384,768,384 C,627,384,512,499,512,640 C,512,781,627,896,768,896 C,909,896,1024,781,1024,640 M,1536,749 C,1536,766,1524,782,1507,785 L,1324,813 C,1314,846,1300,879,1283,911 C,1317,958,1354,1002,1388,1048 C,1393,1055,1396,1062,1396,1071 C,1396,1079,1394,1087,1389,1093 C,1347,1152,1277,1214,1224,1263 C,1217,1269,1208,1273,1199,1273 C,1190,1273,1181,1270,1175,1264 L,1033,1157 C,1004,1172,974,1184,943,1194 L,915,1378 C,913,1395,897,1408,879,1408 L,657,1408 C,639,1408,625,1396,621,1380 C,605,1320,599,1255,592,1194 C,561,1184,530,1171,501,1156 L,363,1263 C,355,1269,346,1273,337,1273 C,303,1273,168,1127,144,1094 C,139,1087,135,1080,135,1071 C,135,1062,139,1054,145,1047 C,182,1002,218,957,252,909 C,236,879,223,849,213,817 L,27,789 C,12,786,0,768,0,753 L,0,531 C,0,514,12,498,29,495 L,212,468 C,222,434,236,401,253,369 C,219,322,182,278,148,232 C,143,225,140,218,140,209 C,140,201,142,193,147,186 C,189,128,259,66,312,18 C,319,11,328,7,337,7 C,346,7,355,10,362,16 L,503,123 C,532,108,562,96,593,86 L,621,-98 C,623,-115,639,-128,657,-128 L,879,-128 C,897,-128,911,-116,915,-100 C,931,-40,937,25,944,86 C,975,96,1006,109,1035,124 L,1173,16 C,1181,11,1190,7,1199,7 C,1233,7,1368,154,1392,186 C,1398,193,1401,200,1401,209 C,1401,218,1397,227,1391,234 C,1354,279,1318,323,1284,372 C,1300,401,1312,431,1323,463 L,1508,491 C,1524,494,1536,512,1536,527 Z" }, trash: { advanceWidth: 1408, commands: "M,512,800 C,512,818,498,832,480,832 L,416,832 C,398,832,384,818,384,800 L,384,224 C,384,206,398,192,416,192 L,480,192 C,498,192,512,206,512,224 M,768,800 C,768,818,754,832,736,832 L,672,832 C,654,832,640,818,640,800 L,640,224 C,640,206,654,192,672,192 L,736,192 C,754,192,768,206,768,224 M,1024,800 C,1024,818,1010,832,992,832 L,928,832 C,910,832,896,818,896,800 L,896,224 C,896,206,910,192,928,192 L,992,192 C,1010,192,1024,206,1024,224 M,1152,76 C,1152,28,1125,0,1120,0 L,288,0 C,283,0,256,28,256,76 L,256,1024 L,1152,1024 L,1152,76 M,480,1152 L,529,1269 C,532,1273,540,1279,546,1280 L,863,1280 C,868,1279,877,1273,880,1269 L,928,1152 M,1408,1120 C,1408,1138,1394,1152,1376,1152 L,1067,1152 L,997,1319 C,977,1368,917,1408,864,1408 L,544,1408 C,491,1408,431,1368,411,1319 L,341,1152 L,32,1152 C,14,1152,0,1138,0,1120 L,0,1056 C,0,1038,14,1024,32,1024 L,128,1024 L,128,72 C,128,-38,200,-128,288,-128 L,1120,-128 C,1208,-128,1280,-34,1280,76 L,1280,1024 L,1376,1024 C,1394,1024,1408,1038,1408,1056 Z" }, file_alt: { advanceWidth: 1536, commands: "M,1468,1156 L,1156,1468 C,1119,1505,1045,1536,992,1536 L,96,1536 C,43,1536,0,1493,0,1440 L,0,-160 C,0,-213,43,-256,96,-256 L,1440,-256 C,1493,-256,1536,-213,1536,-160 L,1536,992 C,1536,1045,1505,1119,1468,1156 M,1024,1400 C,1041,1394,1058,1385,1065,1378 L,1378,1065 C,1385,1058,1394,1041,1400,1024 L,1024,1024 M,1408,-128 L,128,-128 L,128,1408 L,896,1408 L,896,992 C,896,939,939,896,992,896 L,1408,896 Z" }, download_alt: { advanceWidth: 1664, commands: "M,1280,192 C,1280,157,1251,128,1216,128 C,1181,128,1152,157,1152,192 C,1152,227,1181,256,1216,256 C,1251,256,1280,227,1280,192 M,1536,192 C,1536,157,1507,128,1472,128 C,1437,128,1408,157,1408,192 C,1408,227,1437,256,1472,256 C,1507,256,1536,227,1536,192 M,1664,416 C,1664,469,1621,512,1568,512 L,1104,512 L,968,376 C,931,340,883,320,832,320 C,781,320,733,340,696,376 L,561,512 L,96,512 C,43,512,0,469,0,416 L,0,96 C,0,43,43,0,96,0 L,1568,0 C,1621,0,1664,43,1664,96 M,1339,985 C,1329,1008,1306,1024,1280,1024 L,1024,1024 L,1024,1472 C,1024,1507,995,1536,960,1536 L,704,1536 C,669,1536,640,1507,640,1472 L,640,1024 L,384,1024 C,358,1024,335,1008,325,985 C,315,961,320,933,339,915 L,787,467 C,799,454,816,448,832,448 C,848,448,865,454,877,467 L,1325,915 C,1344,933,1349,961,1339,985 Z" }, repeat: { advanceWidth: 1536, commands: "M,1536,1280 C,1536,1306,1520,1329,1497,1339 C,1473,1349,1445,1344,1427,1325 L,1297,1196 C,1156,1329,965,1408,768,1408 C,345,1408,0,1063,0,640 C,0,217,345,-128,768,-128 C,997,-128,1213,-27,1359,149 C,1369,162,1369,181,1357,192 L,1220,330 C,1213,336,1204,339,1195,339 C,1186,338,1177,334,1172,327 C,1074,200,927,128,768,128 C,486,128,256,358,256,640 C,256,922,486,1152,768,1152 C,899,1152,1023,1102,1117,1015 L,979,877 C,960,859,955,831,965,808 C,975,784,998,768,1024,768 L,1472,768 C,1507,768,1536,797,1536,832 Z" }, pencil: { advanceWidth: 1536, commands: "M,363,0 L,256,0 L,256,128 L,128,128 L,128,235 L,219,326 L,454,91 M,886,928 C,886,922,884,916,879,911 L,337,369 C,332,364,326,362,320,362 C,307,362,298,371,298,384 C,298,390,300,396,305,401 L,847,943 C,852,948,858,950,864,950 C,877,950,886,941,886,928 M,832,1120 L,0,288 L,0,-128 L,416,-128 L,1248,704 M,1515,1024 C,1515,1058,1501,1091,1478,1115 L,1243,1349 C,1219,1373,1186,1387,1152,1387 C,1118,1387,1085,1373,1062,1349 L,896,1184 L,1312,768 L,1478,934 C,1501,957,1515,990,1515,1024 Z" }, edit: { advanceWidth: 1792, commands: "M,888,352 L,832,352 L,832,448 L,736,448 L,736,504 L,852,620 L,1004,468 M,1328,1072 C,1337,1063,1336,1048,1327,1039 L,977,689 C,968,680,953,679,944,688 C,935,697,936,712,945,721 L,1295,1071 C,1304,1080,1319,1081,1328,1072 M,1408,478 C,1408,491,1400,502,1388,507 C,1376,512,1363,510,1353,500 L,1289,436 C,1283,430,1280,422,1280,414 L,1280,288 C,1280,200,1208,128,1120,128 L,288,128 C,200,128,128,200,128,288 L,128,1120 C,128,1208,200,1280,288,1280 L,1120,1280 C,1135,1280,1150,1278,1165,1274 C,1176,1270,1188,1273,1197,1282 L,1246,1331 C,1254,1339,1257,1349,1255,1360 C,1253,1370,1246,1379,1237,1383 C,1200,1400,1160,1408,1120,1408 L,288,1408 C,129,1408,0,1279,0,1120 L,0,288 C,0,129,129,0,288,0 L,1120,0 C,1279,0,1408,129,1408,288 M,1312,1216 L,640,544 L,640,256 L,928,256 L,1600,928 M,1756,1084 C,1793,1121,1793,1183,1756,1220 L,1604,1372 C,1567,1409,1505,1409,1468,1372 L,1376,1280 L,1664,992 L,1756,1084 Z" }, play: { advanceWidth: 1408, commands: "M,1384,609 C,1415,626,1415,654,1384,671 L,56,1409 C,25,1426,0,1411,0,1376 L,0,-96 C,0,-131,25,-146,56,-129 Z" }, pause: { advanceWidth: 1536, commands: "M,1536,1344 C,1536,1379,1507,1408,1472,1408 L,960,1408 C,925,1408,896,1379,896,1344 L,896,-64 C,896,-99,925,-128,960,-128 L,1472,-128 C,1507,-128,1536,-99,1536,-64 M,640,1344 C,640,1379,611,1408,576,1408 L,64,1408 C,29,1408,0,1379,0,1344 L,0,-64 C,0,-99,29,-128,64,-128 L,576,-128 C,611,-128,640,-99,640,-64 Z" }, stop: { advanceWidth: 1536, commands: "M,1536,1344 C,1536,1379,1507,1408,1472,1408 L,64,1408 C,29,1408,0,1379,0,1344 L,0,-64 C,0,-99,29,-128,64,-128 L,1472,-128 C,1507,-128,1536,-99,1536,-64 Z" }, resize_full: { advanceWidth: 1536, commands: "M,755,480 C,755,488,751,497,745,503 L,631,617 C,625,623,616,627,608,627 C,600,627,591,623,585,617 L,253,285 L,109,429 C,97,441,81,448,64,448 C,29,448,0,419,0,384 L,0,-64 C,0,-99,29,-128,64,-128 L,512,-128 C,547,-128,576,-99,576,-64 C,576,-47,569,-31,557,-19 L,413,125 L,745,457 C,751,463,755,472,755,480 M,1536,1344 C,1536,1379,1507,1408,1472,1408 L,1024,1408 C,989,1408,960,1379,960,1344 C,960,1327,967,1311,979,1299 L,1123,1155 L,791,823 C,785,817,781,808,781,800 C,781,792,785,783,791,777 L,905,663 C,911,657,920,653,928,653 C,936,653,945,657,951,663 L,1283,995 L,1427,851 C,1439,839,1455,832,1472,832 C,1507,832,1536,861,1536,896 Z" }, resize_small: { advanceWidth: 1536, commands: "M,768,576 C,768,611,739,640,704,640 L,256,640 C,221,640,192,611,192,576 C,192,559,199,543,211,531 L,355,387 L,23,55 C,17,49,13,40,13,32 C,13,24,17,15,23,9 L,137,-105 C,143,-111,152,-115,160,-115 C,168,-115,177,-111,183,-105 L,515,227 L,659,83 C,671,71,687,64,704,64 C,739,64,768,93,768,128 M,1523,1248 C,1523,1256,1519,1265,1513,1271 L,1399,1385 C,1393,1391,1384,1395,1376,1395 C,1368,1395,1359,1391,1353,1385 L,1021,1053 L,877,1197 C,865,1209,849,1216,832,1216 C,797,1216,768,1187,768,1152 L,768,704 C,768,669,797,640,832,640 L,1280,640 C,1315,640,1344,669,1344,704 C,1344,721,1337,737,1325,749 L,1181,893 L,1513,1225 C,1519,1231,1523,1240,1523,1248 Z" }, eye_open: { advanceWidth: 1792, commands: "M,1664,576 C,1493,312,1217,128,896,128 C,575,128,299,312,128,576 C,223,723,353,849,509,929 C,469,861,448,783,448,704 C,448,457,649,256,896,256 C,1143,256,1344,457,1344,704 C,1344,783,1323,861,1283,929 C,1439,849,1569,723,1664,576 M,944,960 C,944,934,922,912,896,912 C,782,912,688,818,688,704 C,688,678,666,656,640,656 C,614,656,592,678,592,704 C,592,871,729,1008,896,1008 C,922,1008,944,986,944,960 M,1792,576 C,1792,601,1784,624,1772,645 C,1588,947,1251,1152,896,1152 C,541,1152,204,947,20,645 C,8,624,0,601,0,576 C,0,551,8,528,20,507 C,204,205,541,0,896,0 C,1251,0,1588,204,1772,507 C,1784,528,1792,551,1792,576 Z" }, eye_close: { advanceWidth: 1792, commands: "M,555,201 C,379,280,232,415,128,576 C,223,723,353,849,509,929 C,469,861,448,783,448,704 C,448,561,517,426,633,342 M,944,960 C,944,934,922,912,896,912 C,782,912,688,819,688,704 C,688,678,666,656,640,656 C,614,656,592,678,592,704 C,592,871,729,1008,896,1008 C,922,1008,944,986,944,960 M,1307,1151 C,1307,1162,1301,1172,1291,1178 C,1270,1190,1176,1248,1158,1248 C,1146,1248,1136,1242,1130,1232 L,1076,1135 C,1017,1146,956,1152,896,1152 C,527,1152,218,949,20,645 C,7,625,0,600,0,576 C,0,551,7,527,20,507 C,135,327,298,177,492,89 C,482,72,448,18,448,2 C,448,-10,454,-20,464,-26 C,485,-38,580,-96,598,-96 C,609,-96,620,-90,626,-80 L,675,9 C,886,386,1095,765,1306,1142 C,1307,1144,1307,1149,1307,1151 M,1344,704 C,1344,732,1341,760,1336,788 L,1056,286 C,1229,352,1344,518,1344,704 M,1792,576 C,1792,602,1785,623,1772,645 C,1694,774,1569,899,1445,982 L,1382,870 C,1495,792,1590,691,1664,576 C,1508,334,1261,157,970,132 L,896,0 C,1197,0,1467,137,1663,362 C,1702,407,1741,456,1772,507 C,1785,529,1792,550,1792,576 Z" }, folder_open: { advanceWidth: 1920, commands: "M,1879,584 C,1879,629,1828,640,1792,640 L,704,640 C,616,640,498,586,440,518 L,104,122 C,88,104,73,80,73,56 C,73,11,124,0,160,0 L,1248,0 C,1336,0,1454,54,1512,122 L,1848,518 C,1864,536,1879,560,1879,584 M,1536,928 C,1536,1051,1435,1152,1312,1152 L,768,1152 L,768,1184 C,768,1307,667,1408,544,1408 L,224,1408 C,101,1408,0,1307,0,1184 L,0,224 C,0,216,1,207,1,199 L,6,205 L,343,601 C,424,697,579,768,704,768 L,1536,768 Z" }, signin: { advanceWidth: 1536, commands: "M,1184,640 C,1184,657,1177,673,1165,685 L,621,1229 C,609,1241,593,1248,576,1248 C,541,1248,512,1219,512,1184 L,512,896 L,64,896 C,29,896,0,867,0,832 L,0,448 C,0,413,29,384,64,384 L,512,384 L,512,96 C,512,61,541,32,576,32 C,593,32,609,39,621,51 L,1165,595 C,1177,607,1184,623,1184,640 M,1536,992 C,1536,1151,1407,1280,1248,1280 L,928,1280 C,883,1280,896,1212,896,1184 C,896,1147,935,1152,960,1152 L,1248,1152 C,1336,1152,1408,1080,1408,992 L,1408,288 C,1408,200,1336,128,1248,128 L,928,128 C,883,128,896,60,896,32 C,896,15,911,0,928,0 L,1248,0 C,1407,0,1536,129,1536,288 Z" }, upload_alt: { advanceWidth: 1664, commands: "M,1280,64 C,1280,29,1251,0,1216,0 C,1181,0,1152,29,1152,64 C,1152,99,1181,128,1216,128 C,1251,128,1280,99,1280,64 M,1536,64 C,1536,29,1507,0,1472,0 C,1437,0,1408,29,1408,64 C,1408,99,1437,128,1472,128 C,1507,128,1536,99,1536,64 M,1664,288 C,1664,341,1621,384,1568,384 L,1141,384 C,1114,310,1043,256,960,256 L,704,256 C,621,256,550,310,523,384 L,96,384 C,43,384,0,341,0,288 L,0,-32 C,0,-85,43,-128,96,-128 L,1568,-128 C,1621,-128,1664,-85,1664,-32 M,1339,936 C,1349,959,1344,987,1325,1005 L,877,1453 C,865,1466,848,1472,832,1472 C,816,1472,799,1466,787,1453 L,339,1005 C,320,987,315,959,325,936 C,335,912,358,896,384,896 L,640,896 L,640,448 C,640,413,669,384,704,384 L,960,384 C,995,384,1024,413,1024,448 L,1024,896 L,1280,896 C,1306,896,1329,912,1339,936 Z" }, save: { advanceWidth: 1536, commands: "M,384,0 L,384,384 L,1152,384 L,1152,0 M,1280,0 L,1280,416 C,1280,469,1237,512,1184,512 L,352,512 C,299,512,256,469,256,416 L,256,0 L,128,0 L,128,1280 L,256,1280 L,256,864 C,256,811,299,768,352,768 L,928,768 C,981,768,1024,811,1024,864 L,1024,1280 C,1044,1280,1083,1264,1097,1250 L,1378,969 C,1391,956,1408,915,1408,896 L,1408,0 M,896,928 C,896,911,881,896,864,896 L,672,896 C,655,896,640,911,640,928 L,640,1248 C,640,1265,655,1280,672,1280 L,864,1280 C,881,1280,896,1265,896,1248 L,896,928 M,1536,896 C,1536,949,1506,1022,1468,1060 L,1188,1340 C,1150,1378,1077,1408,1024,1408 L,96,1408 C,43,1408,0,1365,0,1312 L,0,-32 C,0,-85,43,-128,96,-128 L,1440,-128 C,1493,-128,1536,-85,1536,-32 Z" }, undo: { advanceWidth: 1536, commands: "M,1536,640 C,1536,1063,1191,1408,768,1408 C,571,1408,380,1329,239,1196 L,109,1325 C,91,1344,63,1349,40,1339 C,16,1329,0,1306,0,1280 L,0,832 C,0,797,29,768,64,768 L,512,768 C,538,768,561,784,571,808 C,581,831,576,859,557,877 L,420,1015 C,513,1102,637,1152,768,1152 C,1050,1152,1280,922,1280,640 C,1280,358,1050,128,768,128 C,609,128,462,200,364,327 C,359,334,350,338,341,339 C,332,339,323,336,316,330 L,179,192 C,168,181,167,162,177,149 C,323,-27,539,-128,768,-128 C,1191,-128,1536,217,1536,640 Z" }, paste: { advanceWidth: 1792, commands: "M,768,-128 L,768,1024 L,1152,1024 L,1152,608 C,1152,555,1195,512,1248,512 L,1664,512 L,1664,-128 M,1024,1312 C,1024,1295,1009,1280,992,1280 L,288,1280 C,271,1280,256,1295,256,1312 L,256,1376 C,256,1393,271,1408,288,1408 L,992,1408 C,1009,1408,1024,1393,1024,1376 L,1024,1312 M,1280,640 L,1280,939 L,1579,640 M,1792,512 C,1792,565,1762,638,1724,676 L,1316,1084 C,1305,1095,1293,1104,1280,1112 L,1280,1440 C,1280,1493,1237,1536,1184,1536 L,96,1536 C,43,1536,0,1493,0,1440 L,0,96 C,0,43,43,0,96,0 L,640,0 L,640,-160 C,640,-213,683,-256,736,-256 L,1696,-256 C,1749,-256,1792,-213,1792,-160 Z" }, folder_open_alt: { advanceWidth: 1920, commands: "M,1781,605 C,1781,590,1772,577,1763,566 L,1469,203 C,1435,161,1365,128,1312,128 L,224,128 C,202,128,171,135,171,163 C,171,178,180,191,189,203 L,483,566 C,517,607,587,640,640,640 L,1728,640 C,1750,640,1781,633,1781,605 M,640,768 C,549,768,442,717,384,646 L,128,331 L,128,1184 C,128,1237,171,1280,224,1280 L,544,1280 C,597,1280,640,1237,640,1184 L,640,1120 C,640,1067,683,1024,736,1024 L,1312,1024 C,1365,1024,1408,981,1408,928 L,1408,768 M,1909,605 C,1909,629,1904,652,1894,673 C,1864,737,1796,768,1728,768 L,1536,768 L,1536,928 C,1536,1051,1435,1152,1312,1152 L,768,1152 L,768,1184 C,768,1307,667,1408,544,1408 L,224,1408 C,101,1408,0,1307,0,1184 L,0,224 C,0,101,101,0,224,0 L,1312,0 C,1402,0,1511,52,1568,122 L,1863,485 C,1890,519,1909,561,1909,605 Z" } } }, { style: y } = p; function x(e, t, n, i) { var s = document.createElement("button"); y(s, { padding: "0.2em 0.4em", margin: "0em", background: "none", outline: "none", fontSize: "16px", border: "none", borderRadius: "0.2em" }); var l = document.createElement("canvas"), d = l.getContext("2d"); s.appendChild(l), this.ctx = d, this.dom = s, this.canvas = l; var c = this; this.size = e; var u = 1; this.resize = function () { u = window.devicePixelRatio; var n = e, i = w.fonts[t]; l.height = n * u, l.style.height = n + "px"; var o = n / w.unitsPerEm, r = i.advanceWidth * o + .5 | 0; r += 2, n += 2, l.width = r * u, l.style.width = r + "px", d.fillStyle = a, c.draw() }, i && i.on("resize", this.resize), this.setSize = function (t) { e = t, this.resize() }, this.setIcon = function (e) { c.icon = e, w.fonts[e] || console.warn("Font icon not found!"), this.resize() }, this.onClick = function (e) { s.addEventListener("click", e) }; var h; this.onLongHold = function (e) { function t(t) { t.preventDefault(), t.stopPropagation(), h = setTimeout((function () { h && (console.log("LONG HOLD-ED!"), e()) }), 500) } function n() { clearTimeout(h) } s.addEventListener("mousedown", t), s.addEventListener("touchstart", t), s.addEventListener("mouseup", n), s.addEventListener("mouseout", n), s.addEventListener("touchend", n) }, this.setTip = function (e) { n = e }; var p = { border: "1px solid " + o }, f = { border: "1px solid transparent" }, C = o; s.style.background = "none", y(s, f), s.addEventListener("mouseover", (function () { y(s, p), d.fillStyle = r, d.shadowColor = o, d.shadowBlur = .5 * u, d.shadowOffsetX = 1 * u, d.shadowOffsetY = 1 * u, c.draw(), n && i && i.fire("status", "button: " + n) })), s.addEventListener("mousedown", (function () { s.style.background = C })), s.addEventListener("mouseup", (function () { s.style.background = "none", y(s, p) })), s.addEventListener("mouseout", (function () { s.style.background = "none", y(s, f), c.dropshadow = !1, d.fillStyle = a, d.shadowColor = null, d.shadowBlur = 0, d.shadowOffsetX = 0, d.shadowOffsetY = 0, c.draw() })), t && this.setIcon(t) } x.prototype.CMD_MAP = { M: "moveTo", L: "lineTo", Q: "quadraticCurveTo", C: "bezierCurveTo", Z: "closePath" }, x.prototype.draw = function () { if (this.icon) { var e = this.ctx, t = w.fonts[this.icon], n = this.size, i = window.devicePixelRatio, a = n / w.unitsPerEm * i, r = t.commands.split(" "); if (e.save(), e.clearRect(0, 0, this.canvas.width * i, this.canvas.height * i), this.dropshadow) { e.save(), e.fillStyle = o, e.translate(1.5 * i, 1.5 * i), e.scale(a, -a), e.translate(0, -w.ascender), e.beginPath(); for (let t = 0, n = r.length; t < n; t++) { const n = r[t].split(","), i = n.slice(1); e[this.CMD_MAP[n[0]]].apply(e, i) } e.fill(), e.restore() } e.scale(a, -a), e.translate(0, -w.ascender), e.beginPath(); for (let t = 0, n = r.length; t < n; t++) { const n = r[t].split(","), i = n.slice(1); e[this.CMD_MAP[n[0]]].apply(e, i) } e.fill(), e.restore() } }; const { STORAGE_PREFIX: E, style: T } = p; function M(e, t) { var n = e.get("layers"), i = document.createElement("div"), o = document.createElement("div"); o.style.cssText = "margin: 0px; top: 0; left: 0; height: " + d.MARKER_TRACK_HEIGHT + "px"; var a = document.createElement("div"); T(a, { position: "absolute", top: d.MARKER_TRACK_HEIGHT + "px", left: 0, right: 0, bottom: 0, overflow: "hidden" }), a.id = "layer_scroll", i.appendChild(a); var r = { width: "22px", height: "22px", padding: "2px" }, s = { width: "32px", padding: "3px 4px 3px 4px" }, l = new x(16, "play", "play", t); T(l.dom, r, { marginTop: "2px" }), l.onClick((function (e) { e.preventDefault(), t.fire("controls.toggle_play") })); var c = new x(16, "stop", "stop", t); T(c.dom, r, { marginTop: "2px" }), c.onClick((function (e) { t.fire("controls.stop") })); var u = new x(16, "undo", "undo", t); T(u.dom, s), u.onClick((function () { t.fire("controls.undo") })); var h = new x(16, "repeat", "redo", t); T(h.dom, s), h.onClick((function () { t.fire("controls.redo") })); var p = document.createElement("input"); p.type = "range", p.value = 0, p.min = -1, p.max = 1, p.step = .125, T(p, { width: "90px", margin: "0px", marginLeft: "2px", marginRight: "2px" }); var f = 0; p.addEventListener("mousedown", (function () { f = 1 })), p.addEventListener("mouseup", (function () { f = 0, z() })), p.addEventListener("mousemove", (function () { f && z() })), i.appendChild(o); var C = { min: 0, step: .125 }, v = new L(C), m = new L(C), w = e.get("ui:currentTime"), y = e.get("ui:totalTime"); v.onChange.do((function (e, n) { t.fire("time.update", e) })), m.onChange.do((function (e, t) { y.value = e, N() })), o.appendChild(v.dom), o.appendChild(document.createTextNode("/")), o.appendChild(m.dom), o.appendChild(l.dom), o.appendChild(c.dom), o.appendChild(p); var M = document.createElement("div"); T(M, { marginTop: "4px" }), o.appendChild(M); var S = new x(16, "folder_open_alt", "Open", t); function b() { for (; _.length;)_.remove(0); var e; (e = document.createElement("option")).text = "New", e.value = "*new*", _.add(e), (e = document.createElement("option")).text = "Import JSON", e.value = "*import*", _.add(e), (e = document.createElement("option")).text = "==Open==", e.disabled = !0, e.selected = !0, _.add(e); var t = new RegExp(E + "(.*)"); for (var n in localStorage) { var i = t.exec(n); i && ((e = document.createElement("option")).text = i[1], _.add(e)) } } T(S.dom, s), M.appendChild(S.dom), window.addEventListener("storage", (function (e) { new RegExp(E + "(.*)").exec(e.key) && b() })), t.on("save:done", b); var _ = document.createElement("select"); T(_, { position: "absolute", opacity: 0, width: "16px", height: "16px" }), _.addEventListener("change", (function (e) { switch (_.value) { case "*new*": t.fire("new"); break; case "*import*": t.fire("import"); break; case "*select*": t.fire("openfile"); break; default: t.fire("open", _.value) } })), S.dom.insertBefore(_, S.dom.firstChild), b(); var k = new x(16, "save", "Save", t); T(k.dom, s), M.appendChild(k.dom), k.onClick((function () { t.fire("save") })); var R = new x(16, "paste", "Save as", t); T(R.dom, s), M.appendChild(R.dom), R.onClick((function () { t.fire("save_as") })); var I = new x(16, "download_alt", "Download / Export JSON to file", t); T(I.dom, s), M.appendChild(I.dom), I.onClick((function () { t.fire("export") })); var P = new x(16, "upload_alt", "Load from file", t); T(P.dom, s), M.appendChild(P.dom), P.onClick((function () { t.fire("openfile") })); var H = document.createElement("span"); function z() { t.fire("update.scale", 6 * Math.pow(100, -p.value)) } H.style.width = "20px", H.style.display = "inline-block", M.appendChild(H), M.appendChild(u.dom), M.appendChild(h.dom), M.appendChild(document.createElement("br")); var A = [], O = []; function N(e) { var t; e = w.value, v.setValue(e), m.setValue(y.value), v.paint(), m.paint(), e = e || 0; var i = n.value; for (t = A.length; t-- > 0;)t >= i.length ? (A[t].dom.style.display = "none", O.push(A.pop())) : (A[t].setState(i[t], n.get(t)), A[t].repaint(e)) } this.layers = A, this.setControlStatus = function (e) { e ? (l.setIcon("pause"), l.setTip("Pause")) : (l.setIcon("play"), l.setTip("Play")) }, this.setState = function (e) { var i, o, r = (n = e).value; for (console.log(A.length, r), i = 0; i < r.length; i++) { var s; if (o = r[i], !A[i]) O.length ? (s = O.pop()).dom.style.display = "block" : (s = new g(o, t), a.appendChild(s.dom)), A.push(s) } console.log("Total layers (view, hidden, total)", A.length, O.length, A.length + O.length) }, this.repaint = N, this.setState(n), this.scrollTo = function (e) { a.scrollTop = e * (a.scrollHeight - a.clientHeight) }, this.dom = i, N() } function S() { } function b(e, t) { var n, i; this.setSize = function (e, t) { n = e, i = t }; var r = { left: 0, grip_length: 0, k: 1 }, s = new S; this.paint = function (e) { var l = t.get("ui:totalTime").value, d = t.get("ui:scrollTime").value, c = t.get("ui:currentTime").value, u = t.get("ui:timeScale").value; e.save(); var h = window.devicePixelRatio; e.scale(h, h); var p = n - 30; e.clearRect(0, 0, n, i), e.translate(15, 5), e.beginPath(), e.strokeStyle = o, e.rect(0, 0, p, 16), e.stroke(); var f = p / (l * u); r.k = f; var C = p * f; r.grip_length = C, r.left = d / l * p, s.set(r.left, 0, r.grip_length, 16), s.paint(e); var v = c / l * p; e.fillStyle = a, e.lineWidth = 2, e.beginPath(), e.rect(v, 0, 2, 21), e.fill(), e.fillText(c && c.toFixed(2), v, 30), e.fillText(l, 300, 14), e.restore() }; var l = null; this.onDown = function (i) { if (s.contains(i.offsetx - 15, i.offsety - 5)) l = r.left; else { var o = t.get("ui:totalTime").value, a = (t.get("ui:timeScale").value, n - 30), d = (i.offsetx - 15) / a * o; e.fire("time.update", d), i.preventDefault && i.preventDefault() } }, this.onMove = function (i) { if (null != l) { var o = t.get("ui:totalTime").value, a = n - 30, s = (l + i.dx) / a * o; if (console.log(s, l, i.dx, r.grip_length, a), l + i.dx + r.grip_length > a) return; e.fire("update.scrollTime", s) } else this.onDown(i) }, this.onUp = function (e) { l = null } } function _(e, t) { var n, i, o, a, r, s, l = []; function d(e, t) { o = e, a = t, r = window.devicePixelRatio, n.width = o * r, n.height = a * r, n.style.width = o + "px", n.style.height = a + "px", s && s.setSize(e, t) } n = document.createElement("canvas"), i = n.getContext("2d"), d(e, t), this.setSize = d, this.repaint = function () { !function (e) { s && (s.paint || console.warn("implement repaint()"), s.paint(e)); for (var t = 0; t < l.length; t++)l[t].paint() }(i) }, this.uses = function (e) { (s = e).add = this.add, s.remove = this.remove }, this.dom = n, C(n, (function (e) { s.onDown && s.onDown(e) }), (function (e) { s.onMove && s.onMove(e) }), (function (e) { s.onUp && s.onUp(e) })) } S.prototype.set = function (e, t, n, i, o, a) { this.x = e, this.y = t, this.w = n, this.h = i, this.color = o, this.outline = a }, S.prototype.paint = function (e) { e.fillStyle = o, e.strokeStyle = a, this.shape(e), e.stroke(), e.fill() }, S.prototype.shape = function (e) { e.beginPath(), e.rect(this.x, this.y, this.w, this.h) }, S.prototype.contains = function (e, t) { return e >= this.x && t >= this.y && e <= this.x + this.w && t <= this.y + this.h }; const k = p.proxy_ctx; var R, I, P, H = d.LINE_HEIGHT, z = d.DIAMOND_SIZE, A = d.time_scale, O = 0; function N() { I = 2 * (R = A / 60), P = 10 * R } function W(e, t) { var n, s = window.devicePixelRatio, l = document.createElement("canvas"), c = 0, u = e.get("layers").value; this.scrollTo = function (e, t) { c = e * Math.max(u.length * H - n, 0), W() }, this.resize = function () { var e = d.height - 35; s = window.devicePixelRatio, l.width = d.width * s, l.height = e * s, l.style.width = d.width + "px", l.style.height = e + "px", n = d.height - 35, f.setSize(d.width, 35) }; var h = document.createElement("div"), f = new _(d.width, 35); p.style(l, { position: "absolute", top: "35px", left: "0px" }), p.style(f.dom, { position: "absolute", top: "0px", left: "10px" }), f.uses(new b(t, e)), h.appendChild(l), h.appendChild(f.dom), f.dom.id = "scroll-canvas", l.id = "track-canvas", this.dom = h, this.dom.id = "timeline-panel", this.resize(); var v, m, L, g, w, y = l.getContext("2d"), x = k(y), E = !1, T = []; function M(e, t, n, i, o, a, r, s, d) { this.path = function () { x.beginPath().rect(e, t, n - e, i - t).closePath() }, this.paint = function () { this.path(), y.fillStyle = o._color, y.fill() }, this.mouseover = function () { l.style.cursor = "pointer" }, this.mouseout = function () { l.style.cursor = "default" }, this.mousedrag = function (t) { var i = J(e + t.dx); i = Math.max(0, i), o.time = i; var r = J(n + t.dx); r = Math.max(0, r), a.time = r } } function S(e, n) { var i, o; i = B(e.time), o = n + .5 * H - z / 2; var r = this, s = !1; this.path = function (e) { e.beginPath().moveTo(i, o).lineTo(i + z / 2, o + z / 2).lineTo(i, o + z).lineTo(i - z / 2, o + z / 2).closePath() }, this.paint = function (e) { r.path(e), s ? e.fillStyle("yellow") : e.fillStyle(a), e.fill().stroke() }, this.mouseover = function () { s = !0, l.style.cursor = "move", r.paint(x) }, this.mouseout = function () { s = !1, l.style.cursor = "default", r.paint(x) }, this.mousedrag = function (n) { var o = J(i + n.dx); o = Math.max(0, o), e.time = o, t.fire("time.update", o) } } function W() { E = !0 } function D() { for (T = [], m = 0, w = u.length; m <= w; m++)y.strokeStyle = o, y.beginPath(), g = ~~(g = m * H) - .5, x.moveTo(0, g).lineTo(d.width, g).stroke(); var e, t, n; for (m = 0; m < w; m++) { var i = u[m].values; for (g = m * H, n = 0; n < i.length - 1; n++) { e = i[n], t = i[n + 1]; var a = B(e.time), r = B(t.time); if (e.tween && "none" != e.tween) { var s = g + 2, l = g + H - 2; T.push(new M(a, s, r, l, e, t)) } } for (n = 0; n < i.length; n++)e = i[n], T.push(new S(e, g)) } for (m = 0, w = T.length; m < w; m++)T[m].paint(x) } var Z, F = null, Y = null; function X() { var e, t = F; for (F = null, m = T.length; m-- > 0;)if ((e = T[m]).path(x), y.isPointInPath(K.x * s, K.y * s)) { F = e; break } t && t != F && (e = t).mouseout && e.mouseout(), F && ((e = F).mouseover && e.mouseover(), U && (Y = e)) } function G() { K && x.save().scale(s, s).translate(0, 25).beginPath().rect(0, 0, d.width, n).translate(-0, -c).clip().run(X).restore() } function J(e) { return O + ((e - 20) / (A / P) | 0) / P } function B(e) { var t = e - O; return t *= A, t += 20 } this.repaint = W, this._paint = function () { if (E) { var t; f.repaint(), t = e.get("ui:timeScale").value, A !== t && (A = t, N()), v = e.get("ui:currentTime").value, O = e.get("ui:scrollTime").value, y.fillStyle = i, y.clearRect(0, 0, l.width, l.height), y.save(), y.scale(s, s), y.lineWidth = 1; var u = d.width, h = d.height, C = A / R, g = O * A % C, w = (u - 20 + g) / C; for (m = 0; m < w; m++) { L = m * C + 20 - g, y.strokeStyle = o, y.beginPath(), y.moveTo(L, 0), y.lineTo(L, h), y.stroke(), y.fillStyle = r, y.textAlign = "center"; var T = (m * C - g) / A + O; T = p.format_friendly_seconds(T), y.fillText(T, L, 38) } for (w = (u - 20 + g) / (C = A / I), m = 0; m < w; m++)y.strokeStyle = a, y.beginPath(), L = m * C + 20 - g, y.moveTo(L, 25), y.lineTo(L, 9), y.stroke(); var M = P / I; for (w = (u - 20 + g) / (C = A / P), m = 0; m < w; m++)m % M != 0 && (y.strokeStyle = a, y.beginPath(), L = m * C + 20 - g, y.moveTo(L, 25), y.lineTo(L, 15), y.stroke()); x.save().translate(0, 25).beginPath().rect(0, 0, d.width, n).translate(-0, -c).clip().run(D).restore(), y.strokeStyle = "red", L = (v - O) * A + 20; var S = p.format_friendly_seconds(v), b = y.measureText(S).width / 2 + 4; y.beginPath(), y.moveTo(L, 20), y.lineTo(L, h), y.stroke(), y.fillStyle = "red", y.textAlign = "center", y.beginPath(), y.moveTo(L, 25), y.lineTo(L + 5, 20), y.lineTo(L + b, 20), y.lineTo(L + b, 6), y.lineTo(L - b, 6), y.lineTo(L - b, 20), y.lineTo(L - 5, 20), y.closePath(), y.fill(), y.fillStyle = "white", y.fillText(S, L, 16), y.restore(), E = !1 } else G() }, W(), document.addEventListener("mousemove", (function (e) { Z = l.getBoundingClientRect(); var t = e.clientX - Z.left, n = e.clientY - Z.top; !function (e, t) { if (Y) return; K = { x: e, y: t } }(t, n) })), l.addEventListener("dblclick", (function (e) { Z = l.getBoundingClientRect(); e.clientX, Z.left; var n = function (e) { return e - 25 < 0 ? -1 : (e - 25 + c) / H | 0 }(e.clientY - Z.top); t.fire("keyframe", u[n], v) })); var K = null; l.addEventListener("mouseout", (function () { K = null })); var U = !1, V = !1; C(l, (function (e) { U = !0, K = { x: e.offsetx, y: e.offsety }, G(), Y || t.fire("time.update", J(e.offsetx)) }), (function (e) { U = !1, Y ? (V = !0, Y.mousedrag && Y.mousedrag(e)) : t.fire("time.update", J(e.offsetx)) }), (function (e) { V ? t.fire("keyframe.move") : t.fire("time.update", J(e.offsetx)), U = !1, Y = null, V = !1 })), this.setState = function (e) { u = e.value, W() } } N(); var D = { position: "absolute", background: "-webkit-gradient(linear, left top, right top, color-stop(0, rgb(29,29,29)), color-stop(0.6, rgb(50,50,50)) )", border: "1px solid rgb(29, 29, 29)", textAlign: "center", cursor: "pointer" }, Z = { background: "-webkit-gradient(linear, left top, right top, color-stop(0.2, rgb(88,88,88)), color-stop(0.6, rgb(64,64,64)) )", border: "1px solid rgb(25,25,25)", position: "relative", borderRadius: "6px" }; function F(e, t, n) { var i = t || 12, o = i + 6, a = document.createElement("div"); p.style(a, D); var r = e - 2; a.style.height = r + "px", a.style.width = o + "px"; var s = document.createElement("div"); p.style(s, Z), s.style.width = i + "px", s.style.height = e / 2, s.style.top = 0, s.style.left = "3px", a.appendChild(s); var l, d, c, u = this; function h(e) { e.preventDefault(); var t = r - l, n = (e.clientY - c) / t; n > 1 && (n = 1), n < 0 && (n = 0), u.setPosition(n), u.onScroll.fire("scrollto", n) } function C(e) { h(e), document.removeEventListener("mousemove", h, !1), document.removeEventListener("mouseup", C, !1) } this.setLength = function (e) { e = Math.max(Math.min(1, e), 0), e *= r, l = Math.max(e, 25), s.style.height = l + "px" }, this.setHeight = function (t) { r = (e = t) - 2, a.style.height = r + "px" }, this.setPosition = function (e) { e = Math.max(Math.min(1, e), 0), d = e * (r - l), s.style.top = d + "px" }, this.setLength(1), this.setPosition(0), this.onScroll = new f, a.addEventListener("mousedown", (function (e) { e.preventDefault(), e.target == s ? (c = e.clientY, document.addEventListener("mousemove", h, !1), document.addEventListener("mouseup", C, !1)) : e.clientY < d ? u.onScroll.fire("pageup") : e.clientY > d + l && u.onScroll.fire("pagedown") }), !1), this.dom = a } var Y = "test-version"; function X() { this.DELIMITER = ":", this.blank(), this.onOpen = new f, this.onSave = new f, this.listeners = [] } function G(e, t) { this.path = t, this.store = e } X.prototype.addListener = function (e, t) { this.listeners.push({ path: e, callback: t }) }, X.prototype.blank = function () { var e = {}; e.version = Y, e.modified = (new Date).toString(), e.title = "Untitled", e.ui = { currentTime: 0, totalTime: d.default_length, scrollTime: 0, timeScale: d.time_scale }, e.layers = [], this.data = e }, X.prototype.update = function () { var e = this.data; e.version = Y, e.modified = (new Date).toString() }, X.prototype.setJSONString = function (e) { this.data = JSON.parse(e) }, X.prototype.setJSON = function (e) { this.data = e }, X.prototype.getJSONString = function (e) { return JSON.stringify(this.data, null, e) }, X.prototype.getValue = function (e) { for (var t = e.split(this.DELIMITER), n = this.data, i = 0, o = t.length; i < o; i++) { var a = t[i]; if (void 0 === n[a]) return void console.warn("Cant find " + e); n = n[a] } return n }, X.prototype.setValue = function (e, t) { for (var n, i = e.split(this.DELIMITER), o = this.data, a = 0, r = i.length - 1; n = i[a], a < r; a++)o = o[n]; o[n] = t, this.listeners.forEach((function (t) { e.indexOf(t.path) > -1 && t.callback() })) }, X.prototype.get = function (e, t) { return t && (e = t + this.DELIMITER + e), new G(this, e) }, G.prototype = { get value() { return this.store.getValue(this.path) }, set value(e) { this.store.setValue(this.path, e) } }, G.prototype.get = function (e) { return this.store.get(e, this.path) }; function J(e, t, n, i, o) { e.style.left = t + "px", e.style.top = n + "px", e.style.width = i + "px", e.style.height = o + "px" } function B(e, t) { var n, i, o, a, r, s, l, c, u, h, p = null, C = !1, v = !0; function m() { return v } function L() { J(t, s.left, s.top, s.width, s.height), t.style.opacity = 0 } function g(e) { T(e.touches[0]), e.preventDefault() } function w(e) { S(e.touches[0]) } function y(e) { 0 == e.touches.length && H(e.changedTouches[0]) } function x(e) { T(e) } function E(e) { H(e) } function T(e) { M(e); var t = n || i || a || o, r = !t && m(); p = { x: l, y: c, cx: e.clientX, cy: e.clientY, w: s.width, h: s.height, isResizing: t, isMoving: r, onTopEdge: a, onLeftEdge: o, onRightEdge: n, onBottomEdge: i }, (t || r) && (e.preventDefault(), e.stopPropagation()) } function M(t) { s = e.getBoundingClientRect(), l = t.clientX - s.left, c = t.clientY - s.top, a = c < 2, o = l < 2, n = l >= s.width - 2, i = c >= s.height - 2 } function S(e) { M(h = e), C = !0 } function b() { if (requestAnimationFrame(b), C && (C = !1, n && i || o && a ? e.style.cursor = "nwse-resize" : n && a || i && o ? e.style.cursor = "nesw-resize" : n || o ? e.style.cursor = "ew-resize" : i || a ? e.style.cursor = "ns-resize" : m() ? e.style.cursor = "move" : e.style.cursor = "default", p)) { if (p.isResizing) { if (p.onRightEdge && (e.style.width = Math.max(l, 100) + "px"), p.onBottomEdge && (e.style.height = Math.max(c, 80) + "px"), p.onLeftEdge) { var d = Math.max(p.cx - h.clientX + p.w, 100); d > 100 && (e.style.width = d + "px", e.style.left = h.clientX + "px") } if (p.onTopEdge) { var u = Math.max(p.cy - h.clientY + p.h, 80); u > 80 && (e.style.height = u + "px", e.style.top = h.clientY + "px") } return L(), void k.resizes.fire(s.width, s.height) } if (p.isMoving) { var f = _(); if (f) { I(f); var { left: v, top: g, width: w, height: y } = R; J(t, v, g, w, y), t.style.opacity = .2 } else L(); return r ? void J(e, h.clientX - r.width / 2, h.clientY - Math.min(p.y, r.height), r.width, r.height) : (e.style.top = h.clientY - p.y + "px", void (e.style.left = h.clientX - p.x + "px")) } } } function _() { return h.clientY < 2 ? "full-screen" : h.clientY < 8 ? "snap-top-edge" : h.clientX < 8 ? "snap-left-edge" : window.innerWidth - h.clientX < 8 ? "snap-right-edge" : window.innerHeight - h.clientY < 8 ? "snap-bottom-edge" : void 0 } this.allowMove = function (e) { v = e }, this.maximize = function () { r ? (J(e, s.left, s.top, s.width, s.height), M(), u = null, r = null) : (r = { width: s.width, height: s.height, top: s.top, left: s.left }, u = "full-screen", P()) }, this.resizes = new f; var k = this, R = {}; function I(e) { if (e) { var t, n, i, o; switch (e) { case "full-screen": t = window.innerWidth, n = window.innerHeight, i = 0, o = 0; break; case "snap-top-edge": t = window.innerWidth, n = window.innerHeight / 2, i = 0, o = 0; break; case "snap-left-edge": t = window.innerWidth / 2, n = window.innerHeight, i = 0, o = 0; break; case "snap-right-edge": t = window.innerWidth / 2, n = window.innerHeight, i = window.innerWidth - t, o = 0; break; case "snap-bottom-edge": t = window.innerWidth, n = window.innerHeight / 3, i = 0, o = window.innerHeight - n; break; case "dock-bottom": t = s.width, n = s.height, i = .5 * (window.innerWidth - t), o = window.innerHeight - n }Object.assign(R, { left: i, top: o, width: t, height: n }) } } function P() { if (u) { I(u); var { left: t, top: n, width: i, height: o } = R; J(e, t, n, i, o), k.resizes.fire(i, o) } } function H(e) { M(e), p && p.isMoving && ((u = _()) ? (r = { width: s.width, height: s.height, top: s.top, left: s.left }, P()) : r = null, L()), p = null } window.addEventListener("resize", (function () { P() })), J(e, 0, 0, d.width, d.height), J(t, 0, 0, d.width, d.height), e.addEventListener("mousedown", x), document.addEventListener("mousemove", S), document.addEventListener("mouseup", E), e.addEventListener("touchstart", g), document.addEventListener("touchmove", w), document.addEventListener("touchend", y), s = e.getBoundingClientRect(), u = "dock-bottom", setTimeout(() => P()), L(), b() } var K = p.style, U = p.saveToFile, V = p.openAs, j = p.STORAGE_PREFIX; function q(e) { this.name = e, this.values = [], this._value = 0, this._color = "#" + (16777215 * Math.random() | 0).toString(16) } function Q(a) { var s = new n, l = new X, c = l.get("layers"), u = c.value; window._data = l; var h = new t(s), f = new W(l, s), C = new M(l, s); setTimeout((function () { h.save(new e(l, "Loaded"), !0) })), s.on("keyframe", (function (t, n) { u.indexOf(t); var i = l.get("ui:currentTime").value, o = p.findTimeinLayer(t, i); "number" == typeof o ? (t.values.splice(o, 0, { time: i, value: n, _color: "#" + (16777215 * Math.random() | 0).toString(16) }), h.save(new e(l, "Add Keyframe"))) : (console.log("remove from index", o), t.values.splice(o.index, 1), h.save(new e(l, "Remove Keyframe"))), _() })), s.on("keyframe.move", (function (t, n) { h.save(new e(l, "Move Keyframe")) })), s.on("value.change", (function (t, n, i) { if (!t._mute) { var o = l.get("ui:currentTime").value, a = p.findTimeinLayer(t, o); "number" == typeof a ? (t.values.splice(a, 0, { time: o, value: n, _color: "#" + (16777215 * Math.random() | 0).toString(16) }), i || h.save(new e(l, "Add value"))) : (a.object.value = n, i || h.save(new e(l, "Update value"))), _() } })), s.on("action:solo", (function (e, t) { e._solo = t, console.log(e, t) })), s.on("action:mute", (function (e, t) { e._mute = t })), s.on("ease", (function (t, n) { var i = l.get("ui:currentTime").value, o = p.timeAtLayer(t, i); o && o.entry && (o.entry.tween = n), h.save(new e(l, "Add Ease")), _() })); var v = null; function m() { v = performance.now() - 1e3 * l.get("ui:currentTime").value, C.setControlStatus(!0) } function L() { v = null, C.setControlStatus(!1) } s.on("controls.toggle_play", (function () { v ? L() : m() })), s.on("controls.restart_play", (function () { v || m(), w(0) })), s.on("controls.play", m), s.on("controls.pause", L), s.on("controls.stop", (function () { null !== v && L(), w(0) })); var g = l.get("ui:currentTime"); function w(e) { e = Math.max(0, e), g.value = e, v && (v = performance.now() - 1e3 * e), _() } function y(e) { e || (e = "autosave"); var t = l.getJSONString(); try { localStorage[j + e] = t, s.fire("save:done") } catch (n) { console.log("Cannot save", e, t) } } function E(e) { e || (e = l.get("name").value), (e = prompt("Pick a name to save to (localStorage)", e)) && (l.data.name = e, y(e)) } function T(e) { S(JSON.parse(e)) } function S(t) { l.setJSON(t), void 0 === l.getValue("ui") && l.setValue("ui", { currentTime: 0, totalTime: d.default_length, scrollTime: 0, timeScale: d.time_scale }), h.clear(), h.save(new e(l, "Loaded"), !0), b() } function b() { u = c.value, C.setState(c), f.setState(c), _() } function _() { var e = u.length * d.LINE_HEIGHT; te.setLength(d.TIMELINE_SCROLL_HEIGHT / e), C.repaint(), f.repaint() } function k(e) { e && T(localStorage[j + e]) } s.on("time.update", w), s.on("totalTime.update", (function (e) { })), s.on("update.scrollTime", (function (e) { e = Math.max(0, e), l.get("ui:scrollTime").value = e, _() })), s.on("target.notify", (function (e, t) { a && (a[e] = t) })), s.on("update.scale", (function (e) { console.log("range", e), l.get("ui:timeScale").value = e, f.repaint() })), s.on("controls.undo", (function () { var e = h.undo(); l.setJSONString(e.state), b() })), s.on("controls.redo", (function () { var e = h.redo(); l.setJSONString(e.state), b() })), function e() { if (requestAnimationFrame(e), v) { var t = (performance.now() - v) / 1e3; w(t), t > l.get("ui:totalTime").value && (v = performance.now()) } var n, i; ne && (R.style.width = d.width + "px", R.style.height = d.height + "px", n = C.dom, i = f.dom, n.style.cssText = "position: absolute; left: 0px; top: 0px; height: " + d.height + "px;", K(n, { overflow: "hidden" }), n.style.width = d.LEFT_PANE_WIDTH + "px", i.style.position = "absolute", i.style.top = "0px", i.style.left = d.LEFT_PANE_WIDTH + "px", f.resize(), _(), ne = !1, s.fire("resize")), f._paint() }(), this.openLocalSave = k, s.on("import", function () { var e; (e = prompt("Paste JSON in here to Load")) && (console.log("Loading.. ", e), T(e)) }.bind(this)), s.on("new", (function () { l.blank(), b() })), s.on("openfile", (function () { V((function (e) { T(e) }), R) })), s.on("open", k), s.on("export", (function () { var e = l.getJSONString(), t = prompt("Hit OK to download otherwise Copy and Paste JSON", e); if (console.log(JSON.stringify(l.data, null, "\t")), t) { e = l.getJSONString("\t"); U(e, "timeliner-test.json") } })), s.on("save", (function () { var e = l.get("name").value; e ? y(e) : E(e) })), s.on("save_as", E), this.save = y, this.load = S; var R = document.createElement("div"); K(R, { textAlign: "left", lineHeight: "1em", position: "absolute", top: "22px" }); var I = document.createElement("div"); K(I, { position: "fixed", top: "20px", left: "20px", margin: 0, border: "1px solid " + i, padding: 0, overflow: "hidden", backgroundColor: i, color: r, zIndex: 999, fontFamily: "monospace", fontSize: "12px" }); var P = { position: "absolute", top: "0px", width: "100%", height: "22px", lineHeight: "22px", overflow: "hidden" }, H = { width: "20px", height: "20px", padding: "2px", marginRight: "2px" }, z = document.createElement("div"); K(z, P, { borderBottom: "1px solid " + o, textAlign: "center" }); var A = document.createElement("span"); z.appendChild(A), A.innerHTML = "Timeliner 2.0.0-dev", z.appendChild(A); var O = document.createElement("div"); K(O, P, { textAlign: "right" }), z.appendChild(O); var N = new x(10, "resize_full", "maximize", s); K(N.dom, H, { marginRight: "2px" }), O.appendChild(N.dom); var D = document.createElement("div"), Z = { position: "absolute", width: "100%", height: "22px", lineHeight: "22px", bottom: "0", background: i, fontSize: "11px" }; K(D, Z, { borderTop: "1px solid " + o }), I.appendChild(R), I.appendChild(D), I.appendChild(z); var Y = document.createElement("span"); Y.textContent = "hello!", Y.style.marginLeft = "10px", this.setStatus = function (e) { Y.textContent = e }, s.on("state:save", (function (e) { s.fire("status", e), y("autosave") })), s.on("status", this.setStatus); var G = document.createElement("div"); K(G, Z, { textAlign: "right" }), D.appendChild(Y), D.appendChild(G); new x(12, "zoom_in", "zoom in", s), new x(12, "zoom_out", "zoom out", s), new x(12, "cog", "settings", s); var J = new x(12, "plus", "New Layer", s); J.onClick((function () { ie(prompt("Layer name?")), h.save(new e(l, "Layer added")), _() })), K(J.dom, H), G.appendChild(J.dom); var Q = new x(12, "trash", "Delete save", s); Q.onClick((function () { var e = l.get("name").value; e && localStorage[j + e] && (confirm("Are you sure you wish to delete " + e + "?") && (delete localStorage[j + e], s.fire("status", e + " deleted"), s.fire("save:done"))) })), K(Q.dom, H, { marginRight: "2px" }), G.appendChild(Q.dom); var $ = document.createElement("div"); $.id = "ghostpane", K($, { background: "#999", opacity: .2, position: "fixed", margin: 0, padding: 0, zIndex: 998, transitionProperty: "top, left, width, height, opacity", transitionDuration: "0.25s", transitionTimingFunction: "ease-in-out" }); var ee = document.createElement("timeliner"); document.body.appendChild(ee), ee.createShadowRoot && (ee = ee.createShadowRoot()), window.r = ee, ee.appendChild(I), ee.appendChild($), R.appendChild(C.dom), R.appendChild(f.dom); var te = new F(200, 10); R.appendChild(te.dom), te.onScroll.do((function (e, t) { switch (e) { case "scrollto": C.scrollTo(t), f.scrollTo(t) } })), document.addEventListener("keydown", (function (e) { var t = 32 == e.keyCode, n = 13 == e.keyCode, i = (e.metaKey && 91 == e.keyCode && e.shiftKey, document.activeElement); i.nodeName.match(/(INPUT|BUTTON|SELECT|TIMELINER)/) && i.blur(), t ? s.fire("controls.toggle_play") : n ? s.fire("controls.restart_play") : 27 == e.keyCode ? s.fire("controls.pause") : console.log("keydown", e.keyCode) })); var ne = !0; function ie(e) { var t = new q(e); (u = c.value).push(t), C.setState(c) } this.addLayer = ie, this.dispose = function () { var e = I.parentElement; e.removeChild(I), e.removeChild($) }, this.setTarget = function (e) { a = e }, this.getValues = function (e, t) { t = t || .15, e = e || 2; for (var n = l.get("ui:currentTime").value, i = [], o = -e; o <= e; o++) { for (var a = {}, r = 0; r < u.length; r++) { var s = u[r], d = p.timeAtLayer(s, n + o * t); a[s.name] = d.value } i.push(a) } return i }; var oe = new B(I, $); oe.allowMove(!1), oe.resizes.do((function (e, t) { e -= 4, t -= 44, d.width = e - d.LEFT_PANE_WIDTH, d.height = t, d.TIMELINE_SCROLL_HEIGHT = t - d.MARKER_TRACK_HEIGHT; var n = d.TIMELINE_SCROLL_HEIGHT; te.setHeight(n - 2), K(te.dom, { top: d.MARKER_TRACK_HEIGHT + "px", left: e - 16 + "px" }), ne = !0 })), z.addEventListener("mouseover", (function () { oe.allowMove(!0) })), z.addEventListener("mouseout", (function () { oe.allowMove(!1) })) } window.Timeliner = Q; export { Q as Timeliner };
